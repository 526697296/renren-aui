<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>renren-aui</title>
  <link rel="stylesheet" href="../aui/theme/default/index.css">
  <link rel="stylesheet" href="../aui/theme/default/aui.css">
</head>
<body>
  <div
    class="aui-wrapper"
    :class="{ 'aui-sidebar--fold': sidebarFold }"
    v-loading.fullscreen.lock="loading"
    element-loading-text="拼命加载中">
    <template v-if="!loading">
      <!-- aui-navbar -->
      <nav class="aui-navbar" :class="'aui-navbar--' + navbarLayoutType">
        <div class="aui-navbar__header">
          <h1 class="aui-navbar__brand">
            <a class="aui-navbar__brand-lg" href="javascript:;">renren-aui</a>
            <a class="aui-navbar__brand-mini" href="javascript:;">aui</a>
          </h1>
        </div>
        <div class="aui-navbar__body">
          <el-menu class="aui-navbar__menu mr-auto" mode="horizontal">
            <el-menu-item index="1" @click="sidebarFold = !sidebarFold">
              <svg class="icon-svg aui-navbar__icon-menu aui-navbar__icon-menu--switch" aria-hidden="true"><use xlink:href="#icon-suojin"></use></svg>
            </el-menu-item>
            <el-menu-item index="2">
              <a href="//www.renren.io/" target="_blank">
                <svg class="icon-svg aui-navbar__icon-menu" aria-hidden="true"><use xlink:href="#icon-diqiu"></use></svg>
              </a>
            </el-menu-item>
            <el-menu-item index="3" @click="refreshHandle()">
              <svg class="icon-svg aui-navbar__icon-menu aui-navbar__icon-menu--refresh" aria-hidden="true"><use xlink:href="#icon-refresh"></use></svg>
            </el-menu-item>
          </el-menu>
          <el-menu class="aui-navbar__menu" mode="horizontal">
            <el-menu-item index="1" class="aui-navbar__search">
              <i class="aui-navbar__icon-menu el-icon-search" @click="searchVisible = !searchVisible"></i>
              <el-autocomplete
                v-model="searchValue"
                :fetch-suggestions="searchSuggestionsHandle"
                placeholder="请输入内容"
                class="aui-navbar__search-txt" :class="{ 'is-show': searchVisible }">
              </el-autocomplete>
            </el-menu-item>
            <el-menu-item index="4" @click="fullscreenHandle()">
              <svg class="aui-navbar__icon-menu icon-svg" aria-hidden="true"><use xlink:href="#icon-quanping"></use></svg>
            </el-menu-item>
            <el-menu-item index="3" class="aui-navbar__avatar">
              <el-dropdown :show-timeout="0" placement="bottom">
                <span class="el-dropdown-link">
                  <img src="../aui/img/avatar.png">
                  <span>{{ user.name }}</span>
                  <i class="el-icon-arrow-down el-icon--right"></i>
                </span>
                <el-dropdown-menu slot="dropdown">
                  <el-dropdown-item @click.native="updatePasswordHandle()">修改密码</el-dropdown-item>
                  <el-dropdown-item @click.native="logoutHandle()">退出</el-dropdown-item>
                </el-dropdown-menu>
              </el-dropdown>
            </el-menu-item>
          </el-menu>
        </div>
        <!-- 弹窗, 修改密码 -->
        <el-dialog
          title="修改密码"
          :visible.sync="updatePasswordVisible"
          :append-to-body="true">
          <el-form :model="updatePasswordDataForm" :rules="updatePasswordDataRule" ref="updatePasswordDataForm" @keyup.enter.native="updatePasswordDataFormSubmit()" label-width="80px">
            <el-form-item label="账号">
              <span>{{ user.name }}</span>
            </el-form-item>
            <el-form-item label="原密码" prop="password">
              <el-input type="password" v-model="updatePasswordDataForm.password" placeholder="原密码"></el-input>
            </el-form-item>
            <el-form-item label="新密码" prop="newPassword">
              <el-input type="password" v-model="updatePasswordDataForm.newPassword" placeholder="新密码"></el-input>
            </el-form-item>
            <el-form-item label="确认密码" prop="confirmPassword">
              <el-input type="password" v-model="updatePasswordDataForm.confirmPassword" placeholder="确认密码"></el-input>
            </el-form-item>
          </el-form>
          <span slot="footer" class="dialog-footer">
            <el-button @click="updatePasswordVisible = false">取消</el-button>
            <el-button type="primary" @click="updatePasswordDataFormSubmit()">确定</el-button>
          </span>
        </el-dialog>
      </nav>

      <!-- aui-sidebar -->
      <aside class="aui-sidebar" :class="'aui-sidebar--' + sidebarLayoutSkin">
        <div class="aui-sidebar__inner">
          <el-menu
            :default-active="sidebarMenuActiveName"
            :collapse="sidebarFold"
            :unique-opened="true"
            :collapse-transition="false"
            class="aui-sidebar__menu">
            <aui-sidebar-submenu
              v-for="menu in sidebarMenuList"
              :key="menu.id"
              :menu="menu"
              :sidebar-layout-skin="sidebarLayoutSkin">
            </aui-sidebar-submenu>
          </el-menu>
        </div>
      </aside>

      <!-- aui-content -->
      <div class="aui-content__wrapper">
        <main class="aui-content" :class="{ 'aui-content--tabs': isTab }">
          <el-dropdown v-if="isTab" class="aui-content--tabs-tools" :show-timeout="0">
            <i class="el-icon-arrow-down el-icon--right"></i>
            <el-dropdown-menu slot="dropdown">
              <el-dropdown-item @click.native="tabsCloseCurrentHandle">关闭当前标签页</el-dropdown-item>
              <el-dropdown-item @click.native="tabsCloseOtherHandle">关闭其它标签页</el-dropdown-item>
              <el-dropdown-item @click.native="tabsCloseAllHandle">关闭全部标签页</el-dropdown-item>
            </el-dropdown-menu>
          </el-dropdown>
          <el-tabs
            v-if="isTab"
            v-model="contentTabsActiveName"
            @tab-click="tabSelectedHandle"
            @tab-remove="tabRemoveHandle">
            <el-tab-pane
              v-for="item in contentTabs"
              :closable="item.isTabClosable"
              :key="item.name"
              :label="item.title"
              :name="item.name"
              :class="{ 'is-iframe': item.isIframe }">
              <template v-if="item.name === '1001'">
                <svg slot="label" class="aui-content--tabs-icon-nav icon-svg" aria-hidden="true"><use xlink:href="#icon-home"></use></svg>
              </template>
              <iframe v-if="item.isIframe" :src="item.url" width="100%" height="100%" frameborder="0" scrolling="yes"></iframe>
              <el-card v-else shadow="never" class="aui-card--fill">
                <p>这是一个用于测试tab标签页内容, 为card组件自适应高度demo.</p>
                <p>通过<strong>isIframe</strong>属性控制.</p>
              </el-card>
            </el-tab-pane>
          </el-tabs>
          <el-card v-else shadow="never" class="aui-card--fill">
            <p>这是一个用于测试内容, 为card组件自适应高度demo.</p>
            <p>通过<strong>isTab</strong>属性控制.</p>
          </el-card>
        </main>
      </div>
    </template>
  </div>
  <script src="../aui/plugins/vue-2.5.17/vue.js"></script>
  <script src="../aui/plugins/element-2.4.5/index.js"></script>
  <script src="../aui/plugins/es6-promise-4.2.4/es6-promise.auto.min.js"></script>
  <script src="../aui/plugins/axios-0.18.0/axios.min.js"></script>
  <script src="../aui/plugins/js-cookie-2.2.0/js-cookie.min.js"></script>
  <script src="../aui/plugins/lodash-4.17.10/lodash.min.js"></script>
  <script src="../aui/plugins/qs-6.5.2/qs.min.js"></script>
  <script src="../aui/icons/iconfont.js"></script>
  <script src="../aui/plugins/screenfull-3.3.2/screenfull.min.js"></script>
  <script src="../aui/js/utils.js"></script>
  <script>
    (function () {
      var vm = window.vm = new Vue({
        el: '.aui-wrapper',
        data: function () {
          var validateUpdatePasswordConfirmPassword = function (rule, value, callback) {
            if (vm.updatePasswordDataForm.newPassword !== value) {
              callback(new Error('确认密码与新密码不一致'));
            } else {
              callback();
            }
          }
          return {
            loading: true,
            // 导航条, 布局风格, defalut(白色) / colorful(鲜艳)
            navbarLayoutType: 'defalut',
            // 侧边栏, 布局皮肤, default(白色) / dark(黑色)
            sidebarLayoutSkin: 'dark',
            // 侧边栏, 折叠状态
            sidebarFold: false,
            // 侧边栏, 菜单
            sidebarMenuList: [],
            sidebarMenuActiveName: '',
            // 内容是否通过tab展示
            isTab: true,
            // 内容标签页
            contentTabs: [],
            contentTabsActiveName: '',
            // 用户信息
            user: {
              id: 0,
              name: ''
            },
            // 搜索
            searchVisible: false,
            searchValue: '',
            // 修改密码
            updatePasswordVisible: false,
            updatePasswordDataForm: {
              password: '',
              newPassword: '',
              confirmPassword: ''
            },
            updatePasswordDataRule: {
              password: [
                { required: true, message: '必填项不能为空', trigger: 'blur' }
              ],
              newPassword: [
                { required: true, message: '必填项不能为空', trigger: 'blur' }
              ],
              confirmPassword: [
                { required: true, message: '必填项不能为空', trigger: 'blur' },
                { validator: validateUpdatePasswordConfirmPassword, trigger: 'blur' }
              ]
            }
          }
        },
        beforeCreate () {
          vm = this;
        },
        created () {
          axios.all([
            vm.getUserInfo(),
            vm.getMenuList()
          ]).then(function () {
            vm.loading = false;
            // 注册组件, 侧边栏子菜单
            fnRegistrationAuiSidebarSubmenu();
            // 监听, tab添加事件
            vm.$on('tabAddHandle', vm.tabAddHandle);
            // 初始默认选中菜单
            vm.contentTabs.push({
              'name': '1001',
              'title': '分析页',
              'isTabClosable': false,
              'isIframe': true,
              'url': './modules/dashboard/analysis.html'
            });
            vm.sidebarMenuActiveName = '1001';
            vm.contentTabsActiveName = '1001';
          });
        },
        mounted () {
          // 窗口resize实现媒体查询
          vm.sidebarFold = document.documentElement['clientWidth'] <= 992 || false;
          window.addEventListener('resize', _.debounce(function () {
            vm.sidebarFold = document.documentElement['clientWidth'] <= 992 || false;
          }, 150));
        },
        methods: {
          // 获取当前管理员信息
          getUserInfo: function () {
            return axios.get('../aui/json/sys-user-info.json').then(function (res) {
              if (res.data && res.data.code === 0) {
                vm.user.id = res.data.user.userId;
                vm.user.name = res.data.user.username;
              }
            });
          },
          // 获取菜单列表
          getMenuList: function () {
            return axios.get('../aui/json/sys-menu-nav.json').then(function (res) {
              if (res.data && res.data.code === 0) {
                vm.sidebarMenuList = res.data.data;
              }
            })
          },
          // 刷新
          refreshHandle () {
            var iframeBox = document.querySelector('#pane-' + vm.contentTabsActiveName + ' iframe');
            if (iframeBox) {
              iframeBox.contentWindow.location.reload(true);
            }
          },
          // 搜索提示
          searchSuggestionsHandle (queryString, cb) {
            cb([
              { value: '搜索提示一' },
              { value: '搜索提示二' },
              { value: '搜索提示三' }
            ]);
          },
          // 全屏
          fullscreenHandle () {
            if (!screenfull.enabled) {
              return vm.$message({
                message: '您的浏览器不支持此操作',
                type: 'warning',
                duration: 1500
              });
            }
            screenfull.toggle();
          },
          // 修改密码
          updatePasswordHandle () {
            vm.updatePasswordVisible = true;
            vm.$nextTick(function () {
              vm.$refs['updatePasswordDataForm'].resetFields();
            });
          },
          // 修改密码, 表单提交
          updatePasswordDataFormSubmit () {
            vm.$refs['updatePasswordDataForm'].validate(function (valid) {
              if (valid) {
                vm.$message({
                  message: '操作成功：' + JSON.stringify({
                    password: vm.updatePasswordDataForm.password,
                    newPassword: vm.updatePasswordDataForm.newPassword,
                    confirmPassword: vm.updatePasswordDataForm.confirmPassword
                  }),
                  type: 'success',
                  duration: 1500,
                  onClose: function () {
                    vm.updatePasswordVisible = false;
                  }
                });
              }
            });
          },
          // 退出
          logoutHandle () {
            this.$confirm(`确定进行[退出]操作?`, '提示', {
              confirmButtonText: '确定',
              cancelButtonText: '取消',
              type: 'warning'
            }).then(function () {
              window.location.href = './login.html';
            }).catch(function () {});
          },
          // tabs, 添加tab
          tabAddHandle (menu) {
            var tab = vm.contentTabs.filter(function (item) {
              return item.name === menu.id + '';
            })
            if (tab.length <= 0) {
              tab = {
                'name': menu.id + '',
                'title': menu.title,
                'isTabClosable': true,
                'isIframe': true,
                'url': menu.url
              }
              vm.contentTabs = vm.contentTabs.concat(tab);
            } else {
              tab = tab[0];
            }
            vm.sidebarMenuActiveName = vm.contentTabsActiveName = tab.name;
          },
          // tabs, 删除tab
          tabRemoveHandle (tabName) {
            vm.contentTabs = vm.contentTabs.filter(function (item) {
              return item.name !== tabName;
            });
            if (vm.contentTabs.length >= 1) {
              // 当前选中tab被删除
              if (tabName === vm.contentTabsActiveName) {
                vm.sidebarMenuActiveName = vm.contentTabsActiveName = vm.contentTabs[vm.contentTabs.length - 1].name;
              }
            } else {
              vm.sidebarMenuActiveName = '';
              vm.contentTabsActiveName = 'home';
            }
          },
          // tabs, 选中tab
          tabSelectedHandle (tab) {
            tab = vm.contentTabs.filter(function (item) {
              return item.name === tab.name;
            });
            vm.sidebarMenuActiveName = tab.length >= 1 ? tab[0].name : '';
          },
          // tabs, 关闭当前
          tabsCloseCurrentHandle () {
            if (vm.contentTabsActiveName !== 'home') {
              vm.tabRemoveHandle(vm.contentTabsActiveName);
            }
          },
          // tabs, 关闭其它
          tabsCloseOtherHandle () {
            vm.contentTabs = vm.contentTabs.filter(function (item) {
              return item.name === 'home' || item.name === vm.contentTabsActiveName;
            });
          },
          // tabs, 关闭全部
          tabsCloseAllHandle () {
            vm.contentTabs = vm.contentTabs.filter(function (item) {
              return item.name === 'home';
            });
            vm.sidebarMenuActiveName = '';
            vm.contentTabsActiveName = 'home';
          }
        }
      });

      /**
      * 注册组件, 侧边栏子菜单
      */
      function fnRegistrationAuiSidebarSubmenu () {
        Vue.component('aui-sidebar-submenu', {
          template: '\
            <el-submenu\
              v-if="menu.children && menu.children.length >= 1"\
              :index="menu.id + \'\'"\
              :popper-class="\'aui-sidebar--\' + sidebarLayoutSkin + \'-popper\'">\
              <template slot="title">\
                <svg class="aui-sidebar__menu-icon icon-svg" aria-hidden="true"><use :xlink:href="\'#\' + (menu.icon || \'icon-yuanquan\')"></use></svg>\
                <span>{{ menu.title }}</span>\
              </template>\
              <aui-sidebar-submenu\
                v-for="item in menu.children"\
                :key="item.id"\
                :menu="item"\
                :sidebar-layout-skin="sidebarLayoutSkin">\
              </aui-sidebar-submenu>\
            </el-submenu>\
            <el-menu-item v-else :index="menu.id + \'\'" @click="tabAddHandle(menu)">\
              <svg class="aui-sidebar__menu-icon icon-svg" aria-hidden="true"><use :xlink:href="\'#\' + (menu.icon || \'icon-yuanquan\')"></use></svg>\
              <span>{{ menu.title }}</span>\
            </el-menu-item>',
          props: {
            menu: {
              type: Object,
              required: true
            }
          },
          computed: {
            sidebarLayoutSkin: function () {
              return vm.sidebarLayoutSkin;
            }
          },
          methods: {
            tabAddHandle (menu) {
              vm.$emit('tabAddHandle', menu);
            }
          }
        }); 
      };
    })();
  </script>
</body>
</html>
